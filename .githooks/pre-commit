#!/bin/bash
#
# Pre-commit hook for sandctl
# Runs formatting, static analysis, and linting checks on staged Go files
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Print colored message
print_error() {
    echo -e "${RED}ERROR:${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}WARNING:${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_header() {
    echo -e "\n${YELLOW}▶${NC} $1"
}

# Check for required tools
check_go() {
    if ! command -v go &> /dev/null; then
        print_error "Go is not installed or not in PATH"
        echo "Please install Go from https://go.dev/dl/"
        exit 1
    fi
}

check_golangci_lint() {
    if ! command -v golangci-lint &> /dev/null; then
        print_error "golangci-lint is not installed"
        echo ""
        echo "Install with one of:"
        echo "  brew install golangci-lint"
        echo "  go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
        echo ""
        echo "See: https://golangci-lint.run/welcome/install/"
        exit 1
    fi
}

# Get staged Go files (Added, Copied, Modified - not Deleted)
get_staged_go_files() {
    git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true
}

# Main execution
main() {
    # Check for required tools
    check_go

    # Get staged Go files
    STAGED_GO_FILES=$(get_staged_go_files)

    # Exit early if no Go files are staged
    if [ -z "$STAGED_GO_FILES" ]; then
        echo "No Go files staged, skipping checks"
        exit 0
    fi

    echo "Running pre-commit checks on staged Go files..."

    # Track if any check fails
    FAILED=0

    # Check 1: gofmt
    print_header "Checking formatting (gofmt)..."
    # shellcheck disable=SC2086
    UNFORMATTED=$(gofmt -l $STAGED_GO_FILES)
    if [ -n "$UNFORMATTED" ]; then
        print_error "The following files are not formatted:"
        echo "$UNFORMATTED"
        echo ""
        echo "Run 'make fmt' to fix formatting"
        FAILED=1
    else
        print_success "Formatting check passed"
    fi

    # Check 2: go vet
    print_header "Running static analysis (go vet)..."
    if ! go vet ./... 2>&1; then
        print_error "go vet found issues"
        FAILED=1
    else
        print_success "Static analysis passed"
    fi

    # Check 3: golangci-lint (only if installed)
    if command -v golangci-lint &> /dev/null; then
        print_header "Running linters (golangci-lint)..."
        # shellcheck disable=SC2086
        if ! golangci-lint run --new-from-rev=HEAD~ $STAGED_GO_FILES 2>&1; then
            print_error "golangci-lint found issues"
            FAILED=1
        else
            print_success "Linting passed"
        fi
    else
        print_warning "golangci-lint not installed, skipping lint check"
        echo "Install with: brew install golangci-lint"
    fi

    # Final result
    echo ""
    if [ $FAILED -ne 0 ]; then
        print_error "Pre-commit checks failed. Please fix the issues above."
        echo ""
        echo "To bypass this hook (emergency only): git commit --no-verify"
        exit 1
    fi

    print_success "All pre-commit checks passed!"
    exit 0
}

main "$@"
